name: Weekly Auto Release

on:
  schedule:
    # æ¯å‘¨æ—¥ çº½çº¦æ—¶é—´ 02:00 (å¤ä»¤æ—¶å¯¹åº” UTC 06:00ï¼Œå†¬ä»¤æ—¶å¯¹åº” UTC 07:00)
    - cron: '0 6 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  TIMEZONE: 'America/New_York'

jobs:
  create-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      discussions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²

      - name: Setup timezone
        run: |
          sudo timedatectl set-timezone $TIMEZONE

      - name: Get current date
        id: date
        run: |
          echo "current_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "week_number=$(date +'%Y-W%U')" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      - name: Generate version tag
        id: version
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å·æ ¼å¼: vå¹´ä»½.å‘¨æ•°.ä¿®è®¢å·
          YEAR=$(date +'%Y')
          WEEK=$(date +'%U')
          
          # æ£€æŸ¥æœ¬å‘¨æ˜¯å¦å·²æœ‰release
          EXISTING_TAG=$(git tag -l "v${YEAR}.${WEEK}.*" | tail -1)
          
          if [ -z "$EXISTING_TAG" ]; then
            VERSION="v${YEAR}.${WEEK}.0"
          else
            PATCH=$(echo $EXISTING_TAG | cut -d'.' -f3)
            NEW_PATCH=$((PATCH + 1))
            VERSION="v${YEAR}.${WEEK}.${NEW_PATCH}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Check for changes since last release
        id: changes
        run: |
          # è·å–æœ€æ–°çš„release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "No previous releases found"
          else
            # æ£€æŸ¥è‡ªä¸Šæ¬¡releaseä»¥æ¥æ˜¯å¦æœ‰æ–°çš„æäº¤
            CHANGES=$(git rev-list ${LATEST_TAG}..HEAD --count)
            if [ "$CHANGES" -gt "0" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Found $CHANGES new commits since $LATEST_TAG"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No new commits since $LATEST_TAG"
            fi
          fi

      - name: Generate changelog
        id: changelog
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # è·å–æœ€æ–°çš„release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          echo "## ğŸ“¦ Weekly Release - ${{ steps.date.outputs.current_date }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ”„ Changes since last release:" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -z "$LATEST_TAG" ]; then
            echo "- Initial release" >> CHANGELOG.md
          else
            # è·å–commitä¿¡æ¯
            git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "### ğŸ“Š Statistics:" >> CHANGELOG.md
          echo "- **Release Date**: ${{ steps.date.outputs.current_date }}" >> CHANGELOG.md
          echo "- **Week Number**: ${{ steps.date.outputs.week_number }}" >> CHANGELOG.md
          
          if [ ! -z "$LATEST_TAG" ]; then
            COMMIT_COUNT=$(git rev-list ${LATEST_TAG}..HEAD --count)
            echo "- **Commits**: $COMMIT_COUNT" >> CHANGELOG.md
          
            CONTRIBUTORS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%an" | sort -u | wc -l)
            echo "- **Contributors**: $CONTRIBUTORS" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "*This release was automatically generated by GitHub Actions.*" >> CHANGELOG.md
          
          # è¾“å‡ºchangelogå†…å®¹ç”¨äºrelease
          {
            echo 'changelog<<EOF'
            cat CHANGELOG.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Weekly Release ${{ steps.version.outputs.version }} - ${{ steps.date.outputs.current_date }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: No changes notification
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸  No new changes found since last release. Skipping release creation."
          echo "If you want to force a release, use the 'workflow_dispatch' trigger."